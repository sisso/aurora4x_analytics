<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<script src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
<script src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script>
<script>
$(document).ready(function() {

function loadData(data) {
    var options = {
        animationEnabled: true,
        theme: "light2",
        title:{
            text: "Actual vs Projected Sales"
        },
        axisX:{
            // valueFormatString: "DD MMM"
        },
        axisY: {
            title: "Value",
            suffix: "",
            minimum: 30
        },
        toolTip:{
            shared:true
        },
        legend:{
            cursor:"pointer",
            verticalAlign: "bottom",
            horizontalAlign: "left",
            dockInsidePlotArea: true,
            itemclick: toogleDataSeries
        },
        data: [{
            type: "line",
            showInLegend: true,
            name: "Value",
            markerType: "square",
            // xValueFormatString: "DD MMM, YYYY",
            color: "#F08080",
            yValueFormatString: "#,##0K",
            dataPoints: [
                { x: new Date(2017, 10, 1), y: 63 },
                { x: new Date(2017, 10, 2), y: 69 },
                { x: new Date(2017, 10, 3), y: 65 },
                { x: new Date(2017, 10, 4), y: 70 },
                { x: new Date(2017, 10, 5), y: 71 },
                { x: new Date(2017, 10, 6), y: 65 },
                { x: new Date(2017, 10, 7), y: 73 },
                { x: new Date(2017, 10, 8), y: 96 },
                { x: new Date(2017, 10, 9), y: 84 },
                { x: new Date(2017, 10, 10), y: 85 },
                { x: new Date(2017, 10, 11), y: 86 },
                { x: new Date(2017, 10, 12), y: 94 },
                { x: new Date(2017, 10, 13), y: 97 },
                { x: new Date(2017, 10, 14), y: 86 },
                { x: new Date(2017, 10, 15), y: 89 }
            ]
        }]
    };

    chart_id = 0;

    function add_field(field) {
        $('body').append(`<h3>${field.name}<h3>`);
        // var name = field.name;
        // var historical = field.historical;
        // historical[]{.x .y}
        // var date = new Date(2017, 10, 1);
        // var points = [];
        // for (var i = 1 ; i < data.length ; i ++) {
        //   points.push({ x: date, y: data[i][j] });
        // }

        options.data[0].dataPoints = field.historical;
        options.title.text = field.name;
        $('body').append('<div id="chart_'+chart_id+'" style="height: 370px; width: 100%;"></div>');
        $("#chart_"+chart_id).CanvasJSChart(options);

        chart_id ++;
    }

    function add_pop(pop) {
        $('body').append(`<h2>Population: ${pop.population_id}<h2>`);
        pop.fields.forEach(add_field);
    }

    function add_game(game) {
        $('body').append(`<h1>Game: ${game.game_name}<h1>`);
        game.populations.forEach(add_pop);
    }

    data.games.forEach(add_game);

//    data.games.forEach(game => {
//
//        game.populations.forEach(population => {
//            population.fields.forEach(field => {
//            });
//        });
//    });


    // for (var igame = 0 ; i < data.game.length ; igame ++) {
    // }

    // for (var j = 3 ; j < data[0].length ; j ++) {
    //   var header = data[0][j];
    //   var date = new Date(2017, 10, 1);

    //   var points = [];
    //   for (var i = 1 ; i < data.length ; i ++) {
    //     points.push({ x: date, y: data[i][j] });
    //   }

    //   options.data[0].dataPoints = points;

    //   $('body').append('<div id="chartContainer_'+header+'" style="height: 370px; width: 100%;"></div>');
    //   options.title.text = header;
    //   $("#chartContainer_"+header).CanvasJSChart(options);
    // }

    function toogleDataSeries(e){
        if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
            e.dataSeries.visible = false;
        } else{
            e.dataSeries.visible = true;
        }
        e.chart.render();
    }
}

$.ajax("/data").success(function(data, status, wtf) {
    var json = JSON.stringify(data);
    $("#input").text(json);
    loadData(data);
});

});
</script>
</head>
<body>
<h1>Report</h1>
<textarea id="input">{}
</textarea>
</body>
</html>
